<!DOCTYPE html>
<html>
<head>
	<title>Mach-O Parser</title>
	<link rel="stylesheet" href="gandalf.css" type="text/css" />
	<script type="text/javascript">
		function dload(name)
		{
			var _a = document.createElement('a'); 
			_a.href=window.URL.createObjectURL(
				new Blob([
					new TextEncoder().encode(document.getElementById(name).value)],
					{
						'content-type':'text/plain'
					}
				)
			);
			_a.download=mtool.filename+'.'+name+'.txt';
			_a.click();
		}
	</script>
</head>
<body>
	<center>
		<br/>
		<img src="gandalf.png" height="100px"/>
	</center>
	<h1>Mach-O Parser</h1>
	<p id="status">Special thanks to @kudima and @saelo, improved by @userlandkernel.</p>
	<br/>
	<input type="file" placeholder="Upload Mach-O File...." id='file'><br/>
	<br/>
	<section id="macho-utils" class="hidden">
		<input type="text" id="symname" placeholder="symbol name (e.g _kprintf)..." value=""/>
		<button id="findsym">Find</button><button id="download">Download</button>
		<br/>
		<br/>
		<h3>Segments</h3> <button onclick="dload('segments');">Open</button>
		<textarea id="segments">
			
		</textarea>
		<h3>Sections</h3> <button onclick="dload('sections');">Open</button>
		<textarea id="sections">
			
		</textarea>
		<h3>Symbols</h3> <button onclick="dload('symbols');">Open</button>
		<textarea id="symbols">
			
		</textarea>
		<h3>Disassembly</h3> <button onclick="dload('disasm');">Open</button>
		<textarea id="disasm">
			
		</textarea>
	</section>
	<script type="text/javascript" src="capstone.min.js"></script>
	<script type="text/javascript" src="int64.js"></script>
	<script type="text/javascript" src="rwview.js"></script>
	<script type="text/javascript" src="ibin.js"></script>
	<script type="text/javascript" src="lzssdec.js"></script>
	<script type="text/javascript" src="constants.js"></script>
	<script type="text/javascript" src="macho.js"></script>
	<script type="text/javascript">
		var stdin = document.getElementById('file');
		var stdout = {};
		stdout.context = document.getElementById('macho-utils');
		stdout.symbols = document.getElementById('symbols');
		stdout.segments = document.getElementById('segments');
		stdout.sections = document.getElementById('sections');
		stdout.disasm = document.getElementById('disasm');
		stdout.downloadbtn = document.getElementById('download');
		stdout.status = document.getElementById('status');

		var performMachoAnalysis = function() {

			var filename = stdin.files[0].name;
			var freader = new FileReader();

			var updateUI = function(mtool)
			{
				stdout.context.removeAttribute('class');
				stdout.disasm.value = mtool.instructions;
				stdout.segments.value = mtool.segments;
				stdout.symbols.value = mtool.symbols;
				stdout.sections.value = mtool.sections;
				stdout.status.innerText = 'Sucessfully analyzed and disassembled mach-o.';
			};
			
			freader.onload = function() {
				stdout.status.innerText = 'Analyzing please wait...';
				var buf = new uint8_t(this.result);
				window.machos = [];
				window.currentMachoNum = 0;
				window.machofinder = setInterval(function(buf){
					var i = window.currentMachoNum;
					window.machopercent = "("+((i/buf.byteLength)*100).toFixed(2)+"%)";
					window.foundmacho = "";
					var _threshold = 4000;
					try {
						for(j = i+_threshold; j > i; j--){
							if(window.currentMachoNum >= buf.byteLength){
								stdout.status.innerText = "Found "+window.machos.length+" in the binary!";
								window.currentMachoNum = "done";
								clearInterval(window.machofinder);
							}
							var magic = new RWView(buf.slice(j, j+sizeof(uint32_t)).buffer);

							if(magic.getUint32(0, false) == 0xfeedface 
								|| magic.getUint32(0, false) == 0xfeedfacf
								|| magic.getUint32(0, true) == 0xfeedface
								|| magic.getUint32(0, true) == 0xfeedfacf
							) {
							
								window.machos.push(new MachoTool('macho-'+window.machos.length, buf.slice(j, buf.byteLength)));
								window.foundmacho= "Found new mach-o at offset: 0x"+j.toString(16);
							}
						}
					}
					catch(err){
						window.currentMachoNum+=sizeof(uint32_t);
					}
					window.currentMachoNum+=(_threshold*sizeof(uint32_t));
					stdout.status.innerText = window.foundmacho+" "+"Kext / Submacho analysis: "+window.machopercent;

				}, 0.00, buf);
				if(LZSSDec.dectect(buf.buffer)){
					stdout.status.innerText = 'We got a compressed kernelcache, decompressing it...';
					alert('Feeding me a compressed kernelcache? No problem we got lzssdec!');
					setTimeout(function(buf){
						var filesize = new pointer_t(sizeof(uint32_t));
						var x = LZSSDec.prototype.tryLZSS(buf.buffer, new uint32_t(filesize), stdout.status, function(buf){
							window.mtool = new MachoTool(filename, buf);
							stdout.status.innerText = 'Sucessfully analyzed and disassembled mach-o.';
							stdout.downloadbtn.onclick = function(){window.mtool.download();};
							mtool.disasm();
							updateUI(mtool);
						});
					},0.1, buf);
				}
				else
				{
					window.mtool = new MachoTool(filename, buf);
					stdout.downloadbtn.onclick = function(){window.mtool.download();};
					mtool.disasm();
					updateUI(mtool);
				}
				//mtool = undefined;
				//buf = undefined;
			};

			freader.readAsArrayBuffer(this.files[0]);
		};

		window.onload = function(e)
		{
			stdin.addEventListener('change', performMachoAnalysis, false);
		};
	</script>

</body>
</html>